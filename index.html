<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>TruKid Koordinat Analizi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html,body,#map{height:100%;margin:0}
    .panel{
      position:fixed; top:12px; right:12px; z-index:1000;
      background:#fff; border:1px solid #888; border-radius:12px;
      box-shadow:0 4px 14px rgba(0,0,0,.15); padding:12px; width:290px; font:14px/1.4 system-ui,Segoe UI,Arial
    }
    .panel h3{margin:0 0 8px 0; font-size:16px}
    .panel .kpis{display:grid; grid-template-columns:1fr; gap:6px; margin-top:6px}
    .panel .kpis div{display:flex; justify-content:space-between}
    .panel textarea{width:100%; height:110px; font:12px/1.4 ui-monospace,Consolas,monospace}
    .btn{display:inline-block; padding:8px 10px; border:1px solid #666; border-radius:8px; background:#f7f7f7; cursor:pointer}
    .legend{margin-top:8px; font-size:12px}
    .legend span{display:inline-flex; align-items:center; gap:6px; margin-right:12px}
    .dot{width:12px;height:12px;border-radius:50%;}
    .dot.pharm{background:#2ecc71;border:1px solid #27ae60}
    .dot.cart{background:#3498db;border:1px solid #2c82c9}
  </style>
</head>
<body>
<div id="map"></div>

<div class="panel">
  <h3>Özet</h3>
  <div class="kpis">
    <div><span>Toplam Ürün</span><b id="kpi-urun">130</b></div>
    <div><span>Toplam Satış</span><b id="kpi-satis">336.101,79 TL</b></div>
    <div><span>Toplam Eczane</span><b id="kpi-eczane">65</b></div>
  </div>

  <div class="legend">
    <span><span class="dot pharm"></span>Eczane</span>
    <span><span class="dot cart"></span>Sipariş</span>
  </div>

  <p style="margin:10px 0 6px">Veri (her satır: <i>A;B;C</i>)</p>
  <textarea id="input" placeholder="Eczane;38.450371,27.184098;Perla Eczanesi
123456;41.051602,28.991700;Teşvikiye Eczanesi"></textarea>
  <div style="display:flex; gap:8px; margin-top:8px">
    <button class="btn" id="btn-load">Haritaya Yükle</button>
    <button class="btn" id="btn-clear">Temizle</button>
  </div>
</div>

<script>
  // Basit iki renkli ikon (SVG) — eczane/sepet
  function makeIcon(color, glyph) {
    const svg = encodeURIComponent(`
      <svg xmlns='http://www.w3.org/2000/svg' width='28' height='28' viewBox='0 0 28 28'>
        <circle cx='14' cy='14' r='12' fill='${color}' stroke='rgba(0,0,0,.35)' stroke-width='2'/>
        <g fill='#fff' transform='translate(14,14)'>
          ${glyph === 'plus'
            ? "<rect x='-7' y='-2' width='14' height='4' rx='1.5'/><rect x='-2' y='-7' width='4' height='14' rx='1.5'/>"
            : "<path d='M-9 -4 h16 a2 2 0 0 1 2 2 v1 h-18 v-1 a2 2 0 0 1 2 -2zM-9 0 h18 l-2 8 h-14zM-4 10 a2 2 0 1 0 0 .01zM6 10 a2 2 0 1 0 0 .01z'/>"}
        </g>
      </svg>`);
    return L.icon({
      iconUrl: 'data:image/svg+xml;charset=UTF-8,' + svg,
      iconSize: [28,28], iconAnchor:[14,14], popupAnchor:[0,-12]
    });
  }
  const iconPharm = makeIcon('#2ecc71','plus');
  const iconCart  = makeIcon('#3498db','cart');

  // Harita
  const map = L.map('map', { zoomControl: true }).setView([39.0, 35.0], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18, attribution: '&copy; OpenStreetMap katkıcıları'
  }).addTo(map);
  const layer = L.layerGroup().addTo(map);

  function parseAndPlot(text) {
    layer.clearLayers();
    const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    const bounds = [];
    let eczaneCount = 0;

    for (const line of lines) {
      const parts = line.split(';');
      if (parts.length < 3) continue;
      const tur = (parts[0]||'').trim().toLowerCase();          // A: Eczane / Sipariş No
      const coord = (parts[1]||'').trim();                       // B: Koordinat "lat,lon"
      const name = (parts[2]||'').trim();                        // C: Yazılacak isim

      const m = coord.match(/^\s*(-?\d+(\.\d+)?)\s*,\s*(-?\d+(\.\d+)?)\s*$/);
      if (!m) continue;
      const lat = parseFloat(m[1]), lon = parseFloat(m[3]);

      const isPharm = (tur === 'eczane');
      if (isPharm) eczaneCount++;

      L.marker([lat,lon], { icon: isPharm ? iconPharm : iconCart })
        .bindPopup(`<b>${name}</b><br/><small>${tur === 'eczane' ? 'Eczane' : 'Sipariş'}</small>`)
        .addTo(layer);

      bounds.push([lat,lon]);
    }

    if (bounds.length) map.fitBounds(bounds, { padding:[30,30] });

    // Sağ kutudaki sabit KPI’lar (istendiği gibi sabit tutuluyor)
    // Toplam Ürün = 130, Toplam Satış = 336101,79 TL, Toplam Eczane = 65
    document.getElementById('kpi-urun').textContent  = '130';
    document.getElementById('kpi-satis').textContent = '336.101,79 TL';
    document.getElementById('kpi-eczane').textContent= '65';
  }

  // Örnek kısa veri
  const sample = [
    'Eczane;38.450371,27.184098;Perla Eczanesi',
    'Eczane;39.890670,32.709117;Seferoğlu Eczanesi',
    '123456;41.051602,28.991700;Teşvikiye Eczanesi'
  ].join('\n');
  const ta = document.getElementById('input');
  ta.value = sample;

  document.getElementById('btn-load').onclick = () => parseAndPlot(ta.value);
  document.getElementById('btn-clear').onclick = () => { ta.value=''; layer.clearLayers(); };

  // İlk çizim
  parseAndPlot(ta.value);
</script>
</body>
</html>
