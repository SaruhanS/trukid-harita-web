
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>TruKid Harita</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <style>
        html, body, #map { height: 100%; margin: 0; padding: 0; }
        .info-box {
            position: fixed;
            top: 10px;
            left: 100px;
            background: white;
            padding: 8px 12px;
            font-size: 13px;
            border: 1px solid #888;
            border-radius: 6px;
            z-index: 999;
            line-height: 1.5;
        }
        .product-summary {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: white;
            padding: 10px;
            font-size: 12px;
            border: 1px solid #888;
            border-radius: 6px;
            z-index: 999;
            max-height: 200px;
            overflow-y: auto;
            width: 200px;
        }
    </style>
</head>
<body>
<div id="map"></div>
<div class="info-box" id="infoBox"></div>
<div class="product-summary" id="productSummary"></div>

<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<script>
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT_J8Lyv0E8v9pFzTg5IVNxD2MQD-bONUgRLIjAY3FecnaeL2MzBj9hl-EioDbcaYXI6E-M_-u9vMCu/pub?output=csv';

    const map = L.map('map').setView([39.0, 35.0], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap katkÄ±cÄ±lara'
    }).addTo(map);

    const eczaneLayer = L.layerGroup().addTo(map);
    const siparisLayer = L.layerGroup().addTo(map);
    const overlays = {
        "ðŸ”´ Eczane NoktalarÄ±": eczaneLayer,
        "ðŸ”µ SipariÅŸ NoktalarÄ±": siparisLayer
    };
    L.control.layers(null, overlays, { collapsed: false }).addTo(map);

    let eczaneCount = 0;
    let siparisCount = 0;
    let urunCount = 0;
    let productCounter = {};

    Papa.parse(sheetUrl, {
        download: true,
        header: true,
        complete: function(results) {
            results.data.forEach(row => {
                const tip = row['SipariÅŸ No'];
                const [lat, lon] = row['Koordinat'].split(',').map(Number);
                const urun = row['ÃœrÃ¼n AdÄ±'] || 'Bilinmeyen ÃœrÃ¼n';

                if (!lat || !lon) return;

                const isEczane = tip.toLowerCase() === 'eczane';
                const popup = isEczane ? `<b>Eczane:</b><br>${urun}` : `<b>SipariÅŸ:</b> ${tip}<br>${urun}`;
                const iconUrl = isEczane
                    ? 'https://cdn-icons-png.flaticon.com/512/2965/2965567.png'  // Eczane
                    : 'https://cdn-icons-png.flaticon.com/512/107/107831.png';  // Sepet

                const icon = L.icon({
                    iconUrl: iconUrl,
                    iconSize: [30, 30],
                    iconAnchor: [15, 30],
                    popupAnchor: [0, -28]
                });

                const marker = L.marker([lat, lon], { icon }).bindPopup(popup);
                if (isEczane) {
                    eczaneCount++;
                    marker.addTo(eczaneLayer);
                } else {
                    siparisCount++;
                    urunCount++;
                    marker.addTo(siparisLayer);
                    productCounter[urun] = (productCounter[urun] || 0) + 1;
                }
            });

            document.getElementById('infoBox').innerHTML = `
                ðŸ”´ <b>Eczane SayÄ±sÄ±:</b> ${eczaneCount}<br>
                ðŸ”µ <b>SipariÅŸ SayÄ±sÄ±:</b> ${siparisCount}<br>
                ðŸŸ¢ <b>ÃœrÃ¼n SatÄ±rÄ±:</b> ${urunCount}
            `;

            const sorted = Object.entries(productCounter).sort((a,b) => b[1]-a[1]);
            let summaryHTML = '<b>SatÄ±lan ÃœrÃ¼nler:</b><br><table>';
            sorted.forEach(([urun, adet]) => {
                summaryHTML += `<tr><td>${urun}</td><td style="text-align:right; padding-left: 8px;">${adet}</td></tr>`;
            });
            summaryHTML += '</table>';
            document.getElementById('productSummary').innerHTML = summaryHTML;
        }
    });
</script>
</body>
</html>
